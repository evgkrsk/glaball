name: Go

on:
  push:
    tags:
      - '**'

jobs:

  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.17

    - name: Build
      run: |
        versionflags="-X 'github.com/flant/gitlaball/pkg/version.Version=$GITHUB_REF_NAME' -X 'github.com/flant/gitlaball/pkg/version.Revision=$GITHUB_SHA' -X 'github.com/flant/gitlaball/pkg/version.Branch=$GITHUB_REF_NAME' -X 'github.com/flant/gitlaball/pkg/version.BuildUser=$GITHUB_ACTOR' -X 'github.com/flant/gitlaball/pkg/version.BuildDate=$(date +%Y%m%d%H%M)'"
        for GOOS in darwin linux windows; do
          for GOARCH in amd64 arm64; do
            export GOOS GOARCH
            CGO_ENABLED=0 go build -v -a -tags netgo -ldflags="-extldflags '-static' -s -w $versionflags" -o build/gitlaball-${GOOS}-${GOARCH} *.go
            if [[ $GOOS == "windows" ]]; then mv build/gitlaball-${GOOS}-${GOARCH} build/gitlaball-${GOOS}-${GOARCH}.exe; fi
          done
        done
        cd build; sha256sum * > sha256sums.txt

    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          build/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
